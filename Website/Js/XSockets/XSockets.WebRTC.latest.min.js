var RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null;navigator.mozGetUserMedia?(webrtcDetectedBrowser="firefox",RTCPeerConnection=mozRTCPeerConnection,RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),attachMediaStream=function(n,t){n.mozSrcObject=t;n.play()},reattachMediaStream=function(n,t){n.mozSrcObject=t.mozSrcObject;n.play()},MediaStream.prototype.getVideoTracks=function(){return[]},MediaStream.prototype.getAudioTracks=function(){return[]}):navigator.webkitGetUserMedia&&(webrtcDetectedBrowser="chrome",RTCPeerConnection=webkitRTCPeerConnection,getUserMedia=navigator.webkitGetUserMedia.bind(navigator),attachMediaStream=function(n,t){n.src=webkitURL.createObjectURL(t)},reattachMediaStream=function(n,t){n.src=t.src},webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks},webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams},webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams}));XSockets.PeerContext=function(n,t){this.PeerId=n;this.Context=t};XSockets.WebRTC=function(n,t){var r=this,u=[],e;this.PeerConnections={};this.DataChannels={};var f=XSockets.Utils.extend({RTCConfiguration:{iceServers:[{url:"stun:stun.l.google.com:19302"}]},MediaConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},optional:[{RtpDataChannels:!0}]},sdpExpressions:[]},t),c=function(){var n=[],t,i;return this.add=function(i,r,u){var f,e;return(i=i.toLowerCase(),f=this.get(i),f===null)?(e=new t(i),e.addCallback(r,u),n.push(e),1):(f.addCallback(r,u),f.Callbacks.length)},this.get=function(t){t=t.toLowerCase();for(var i=0;i<n.length;i++)if(n[i].Name===t)return n[i];return null},this.getAll=function(){return n},this.remove=function(t,i){t=t.toLowerCase();for(var r=0;r<n.length;r++)if(n[r].Name===t)return i===undefined?n.splice(r,1):(n[r].Callbacks.splice(i-1,1),n[r].Callbacks.length===0&&n.splice(r,1)),!0;return!1},this.fire=function(t,i,r,u){t=t.toLowerCase();for(var f=0;f<n.length;f++)n[f].Name===t&&(u===undefined?n[f].fireCallbacks(i,r):n[f].fireCallback(i,r,u))},t=function(n){this.Name=n;this.Callbacks=[];this.addCallback=function(n,t){this.Callbacks.push(new i(n,t))};this.fireCallback=function(n,t,i){this.Callbacks[i-1].fn(n);typeof this.Callbacks[i-1].state=="object"&&typeof this.Callbacks[i-1].state.options!="undefined"&&typeof this.Callbacks[i-1].state.options.counter!="undefined"&&(this.Callbacks[i-1].state.options.counter.messages--,this.Callbacks[i-1].state.options.counter.messages===0&&typeof this.Callbacks[i-1].state.options.counter.completed=="function"&&this.Callbacks[i-1].state.options.counter.completed());t&&typeof t=="function"&&t()};this.fireCallbacks=function(n,t){for(var i=0;i<this.Callbacks.length;i++)this.fireCallback(n,t,i+1)}},i=function(n,t){this.fn=n;this.state=t},this};this.bind=function(n,t,i,r){return o.add(n,t),r&&typeof r=="function"&&r(),this};this.unbind=function(n,t){return o.remove(n),t&&typeof t=="function"&&t(),this};this.dispatch=function(n,t){o.get(n)!==null&&(typeof t=="string"&&(t=JSON.parse(t)),o.fire(n,t,function(){}))};this.channelPublish=function(n,t){var u,i,f;for(u in r.DataChannels)i=r.DataChannels[u],i.readyState==="open"&&(f=new XSockets.Message(n,t),i.send(JSON.stringify(f)));return this};this.closeChannel=function(n){return r.DataChannels[n].close(),this};this.channelSubscribe=function(n,t,i){return r.bind(t+n,i),this};this.channelUnsubscribe=function(n,t,i){return r.unbind(t+n,i),this};e=!1;this.muteAudio=function(n){u.forEach(function(n){var t=n.getAudioTracks();if(t.length!==0)if(e)for(i=0;i<t.length;i++)t[i].enabled=!0;else for(i=0;i<t.length;i++)t[i].enabled=!1});e=!e;n&&n(e)};this.hasStream=function(){return u.length>0};this.leaveContext=function(){return n.publish("leaveContext",{}),this};this.changeContext=function(t){return n.publish("changecontext",{context:t}),this};this.getLocalStreams=function(){return u};this.removeStream=function(t,i){u.forEach(function(f,e){if(f.id===t){u[e].stop();for(var o in r.PeerConnections)r.PeerConnections[o].Connection.removeStream(u[e]),u.splice(e,1),s({PeerId:o}),n.publish("removestream",{recipient:o,streamId:t}),i&&i(t)}})};this.userMediaConstraints={qvga:function(n){return{video:{mandatory:{maxWidth:320,maxHeight:180}},audio:typeof n!="boolean"?!1:n}},vga:function(n){return{video:{mandatory:{maxWidth:640,maxHeight:360}},audio:typeof n!="boolean"?!1:n}},hd:function(n){return{video:{mandatory:{minWidth:1280,minHeight:720}},audio:typeof n!="boolean"?!1:n}},create:function(n,t,i){return{video:{mandatory:{minWidth:n,minHeight:t}},audio:typeof i!="boolean"?!1:i}},screenSharing:function(){return{video:{mandatory:{chromeMediaSource:"screen"}}}}};this.getRemotePeers=function(){var n=[];for(var t in r.PeerConnections)n.push(t);return n};this.refreshStreams=function(n,t){u.forEach(function(t,i){r.PeerConnections[n].Connection.removeStream(u[i])});s({PeerId:n});t&&t(n)};this.addLocalStream=function(t,i){var f=u.push(t);return n.trigger("AddStream",{streamId:t.id,description:""}),r.dispatch(XSockets.WebRTC.Events.onlocalStream,t),i&&i(t,f),this};this.removePeerConnection=function(t,i){n.publish("peerconnectiondisconnect",{Recipient:t,Sender:r.CurrentContext.PeerId});r.PeerConnections[t]!==undefined&&(r.PeerConnections[t].Connection.close(),r.dispatch(XSockets.WebRTC.Events.onPeerConnectionLost,{PeerId:t}));delete r.PeerConnections[t];i&&i()};this.getUserMedia=function(t,i,f){return window.getUserMedia(t,function(t){u.push(t);n.trigger("AddStream",{streamId:t.id,description:""});r.dispatch(XSockets.WebRTC.Events.onlocalStream,t);i&&typeof i=="function"&&i(r.CurrentContext)},function(n){f&&typeof f=="function"&&f(n)}),this};var o=new c,h=function(t,i){var u=this;this.PeerId=i;this.Connection=new RTCPeerConnection(t.RTCConfiguration,t.MediaConstraints);this.Connection.onconnection=function(){};try{r.DataChannels[i]=this.Connection.createDataChannel("RTCDataChannel",{reliable:!1});r.DataChannels[i].onmessage=function(n){var t=JSON.parse(n.data).JSON;r.dispatch(u.PeerId+t.event,t.data,u.PeerId)};r.DataChannels[i].onopen=function(){r.dispatch(XSockets.WebRTC.Events.onDataChannelOpen,{PeerId:r.DataChannels[i]})};r.DataChannels[i].onclose=function(){r.dispatch(XSockets.WebRTC.Events.onDataChannelClose,{PeerId:r.DataChannels[i]})}}catch(f){console.log("'Create Data channel failed with exception:",f.message)}this.Connection.onaddstream=function(n){r.dispatch(XSockets.WebRTC.Events.onRemoteStream,{PeerId:u.PeerId,stream:n.stream})};this.Connection.onicecandidate=function(t){if(t.candidate){var i={type:"candidate",label:t.candidate.sdpMLineIndex,id:t.candidate.sdpMid,candidate:t.candidate.candidate};n.publish("contextsignal",{sender:r.CurrentContext.PeerId,recipient:u.PeerId,message:JSON.stringify(i)})}};r.dispatch(XSockets.WebRTC.Events.onPeerConnectionCreated,new l(u.PeerId))},l=function(n){this.PeerId=n;this.publish=function(n,t,i){var f,u,e;for(f in r.DataChannels)u=r.DataChannels[f],u.readyState==="open"&&(e=new XSockets.Message(event,json),u.send(JSON.stringify(e)));typeof i=="function"&&i()};this.subscribe=function(n,t){r.bind(this.Id+n,t)};this.unsubscribe=function(n,t){r.unbind(this.Id+n,t)}},s=function(t){r.PeerConnections[t.PeerId]=new h(f,t.PeerId);u.forEach(function(n){r.PeerConnections[t.PeerId].Connection.addStream(n)});r.PeerConnections[t.PeerId].Connection.createOffer(function(i){f.sdpExpressions.forEach(function(n){i.sdp=n(i.sdp)});r.PeerConnections[t.PeerId].Connection.setLocalDescription(i);n.publish("contextsignal",{Sender:r.CurrentContext.PeerId,Recipient:t.PeerId,Message:JSON.stringify(i)})},null,f.MediaConstraints)};r.bind("connect",function(n){s(n)});r.bind("candidate",function(n){var t=JSON.parse(n.Message);r.PeerConnections[n.Sender].Connection.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:t.label,candidate:t.candidate}))});r.bind("answer",function(n){r.dispatch(XSockets.WebRTC.Events.onAnswer,{PeerId:n.Sender});r.PeerConnections[n.Sender].Connection.setRemoteDescription(new RTCSessionDescription(JSON.parse(n.Message)))});r.bind("offer",function(t){r.dispatch(XSockets.WebRTC.Events.onOffer,{PeerId:t.Sender});r.PeerConnections[t.Sender]=new h(f,t.Sender);r.PeerConnections[t.Sender].Connection.setRemoteDescription(new RTCSessionDescription(JSON.parse(t.Message)));u.forEach(function(n){r.PeerConnections[t.Sender].Connection.addStream(n)});r.PeerConnections[t.Sender].Connection.createAnswer(function(i){r.PeerConnections[t.Sender].Connection.setLocalDescription(i);f.sdpExpressions.forEach(function(n){i.sdp=n(i.sdp)});var u={Sender:r.CurrentContext.PeerId,Recipient:t.Sender,Message:JSON.stringify(i)};n.publish("contextsignal",u)},null,f.MediaConstraints)});n.subscribe("contextcreated",function(n){r.CurrentContext=new XSockets.PeerContext(n.PeerId,n.Context);r.dispatch(XSockets.WebRTC.Events.onContextCreated,n)},function(){n.publish("GetContext")});n.subscribe("contextsignal",function(n){var t=JSON.parse(n.Message);r.dispatch(t.type,n)});n.subscribe("contextchanged",function(n){r.dispatch(XSockets.WebRTC.Events.onContextChange,n)});n.subscribe("contextconnect",function(n){n.forEach(function(n){r.dispatch("connect",n);r.dispatch(XSockets.WebRTC.Events.onPeerConnectionStarted,n)})});n.subscribe("peerconnectiondisconnect",function(n){r.PeerConnections[n.Sender]!==undefined&&(r.PeerConnections[n.Sender].Connection.close(),r.dispatch(XSockets.WebRTC.Events.onPeerConnectionLost,{PeerId:n.Sender}),delete r.PeerConnections[n.Sender])});n.subscribe("streamadded",function(n){r.dispatch(XSockets.WebRTC.Events.onLocalStreamCreated,n)});n.subscribe("streamremoved",function(n){r.dispatch(XSockets.WebRTC.Events.onRemoteStreamLost,{PeerId:n.Sender,StreamId:n.StreamId})});n.subscribe("peerconnectionlost",function(n){r.PeerConnections[n.PeerId]!==undefined&&(r.PeerConnections[n.PeerId].Connection.close(),r.dispatch(XSockets.WebRTC.Events.onPeerConnectionLost,{PeerId:n.PeerId}),delete r.PeerConnections[n.PeerId])})};XSockets.WebRTC.CallManager=function(n,t){var i=t.events;this.call=function(t){n.trigger("offercontext",{PeerId:t.PeerId})};this.acceptCall=function(n){i.onAcceptCall(n)};this.denyCall=function(t){n.trigger("denycontext",{PeerId:t.PeerId})};this.endCall=function(){n.trigger("leavecontext",{})};n.subscribe("contextoffer",i.onCall);n.subscribe("contextdeny",i.onDenyCall)};XSockets.WebRTC.Events={onlocalStream:"localstream",onRemoteStream:"remotestream",onRemoteStreamLost:"removestream",onLocalStreamCreated:"streamadded",onContextChange:"contexchanged",onContextCreated:"contextcreated",onPeerConnectionStarted:"peerconnectionstarted",onPeerConnectionCreated:"peerconnectioncreated",onPeerConnectionLost:"peerconnectionlost",onDataChannelOpen:"datachannelopen",onDataChannelClose:"datachannelclose",onOffer:"sdpoffer",onAnswer:"sdanswer"};
/*
//# sourceMappingURL=XSockets.WebRTC.latest.min.js.map
*/